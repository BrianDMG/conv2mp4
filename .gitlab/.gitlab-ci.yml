include:
  - ${CI_PROJECT_DIR}/.gitlab/.gitlab-vars.yml

services:
- ${DOCKER_SERVICE}

stages:
  - Lint
  - Test
  - Docker

Powershell Lint:
  stage: Lint
  only:
    changes:
      - ${CI_PROJECT_DIR}/conv2mp4-ps.ps1
      - ${CI_PROJECT_DIR}/files
  except:
    - tags
  image: ${LINT_IMAGE}
  before_script:
    - pwsh -Version
  script:
    - ${LINT_CMD}

Dockerfile Lint:
  stage: Lint
  only:
    changes:
      - ${DOCKERFILE_PATH}
  image: ${DOCKER_LINT_IMAGE}
  script: ${DOCKER_LINT_CMD} ${DOCKERFILE_PATH}

Lint Dockerfile Lint:
  stage: Lint
  only:
    changes:
      - ${DOCKERFILE_LINT_PATH}
  image: ${DOCKER_LINT_IMAGE}
  script: ${DOCKER_LINT_CMD} ${DOCKERFILE_LINT_PATH}

Unit Test:
  stage: Test
  only:
    changes:
      - ${CI_PROJECT_DIR}/conv2mp4-ps.ps1
      - ${CI_PROJECT_DIR}/files
  except:
    - tags
  script:
    - echo "TODO - Add Pester tests"

Build:
  stage: Docker
#  only:
#    changes:
#      - ${CI_PROJECT_DIR}/conv2mp4-ps.ps1
#      - ${CI_PROJECT_DIR}/files
#      - ${CI_PROJECT_DIR}/.docker
  except:
    - merge_requests
    - tags
  image: ${DOCKER_IMAGE}
  before_script:
    - echo -n ${CI_JOB_TOKEN} | docker login -u gitlab-ci-token --password-stdin ${CI_REGISTRY}
  script:
    - >
      docker build
      --pull
      --cache-from ${LATEST_TAG}
      --tag ${COMMIT_TAG}
      ${DOCKERFILE_PATH}
    - docker push ${COMMIT_TAG}

Lint Build:
  stage: Docker
  only:
    changes:
      - ${DOCKERFILE_LINT_PATH}
  except:
    - merge_requests
    - tags
  image: ${DOCKER_IMAGE}
  before_script:
    - echo -n ${CI_JOB_TOKEN} | docker login -u gitlab-ci-token --password-stdin ${CI_REGISTRY}
  script:
    - >
      docker build
      --pull
      --cache-from ${LINT_LATEST_TAG}
      --tag ${LINT_COMMIT_TAG}
      ${DOCKERFILE_LINT_PATH}
    - docker push ${LINT_COMMIT_TAG}

Smoke Test:
  stage: Docker
  only:
    changes:
      - ${CI_PROJECT_DIR}/conv2mp4-ps.ps1
      - ${CI_PROJECT_DIR}/files
<<<<<<< HEAD
=======
      - ${CI_PROJECT_DIR}/.docker
>>>>>>> 0182c9420664dc3bed83f4b976e33c9b802b4484
  except:
    - tags
  script:
    - echo "TODO - Add container smoke tests"
  needs: ["Build"]

Push:
  stage: Docker
  only:
    changes:
      - ${CI_PROJECT_DIR}/conv2mp4-ps.ps1
      - ${CI_PROJECT_DIR}/files
      - ${CI_PROJECT_DIR}/.docker
  except:
    - merge_requests
    - tags
  image: ${DOCKER_IMAGE}
  before_script:
    - echo -n ${CI_JOB_TOKEN} | docker login -u gitlab-ci-token --password-stdin ${CI_REGISTRY}
  script:
    - docker pull ${COMMIT_TAG}
    - docker tag ${COMMIT_TAG} ${LATEST_TAG}
    - docker push ${LATEST_TAG}
  needs: ["Smoke Test"]

Release:
  stage: Docker
  only:
    - tags
  image: ${DOCKER_IMAGE}
  before_script:
    - echo -n ${CI_JOB_TOKEN} | docker login -u gitlab-ci-token --password-stdin ${CI_REGISTRY}
  script:
    - docker pull ${LATEST_TAG}
    - docker tag ${LATEST_TAG} ${RELEASE_TAG}
    - docker push ${RELEASE_TAG}